name: Build and Publish HA Add-on Docker Images

on:
  # Chạy khi có push vào nhánh main
  push:
    branches: [main]
    paths:
      - 'vfdashboard/**'  # Chỉ chạy khi file trong thư mục vfdashboard thay đổi
  # Chạy khi tạo release
  release:
    types: [published]
  # Cho phép chạy thủ công từ tab Actions
  workflow_dispatch:

# Thiết lập quyền cho GITHUB_TOKEN
permissions:
  contents: read
  packages: write

jobs:
  # Job 1: Build và push Docker images cho mọi kiến trúc
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: aarch64
            platform: linux/arm64
          - arch: armhf
            platform: linux/arm/v7
          - arch: armv7
            platform: linux/arm/v7
    
    steps:
      # 1. Checkout mã nguồn
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. Thiết lập QEMU để build multi-arch
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 3. Thiết lập Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
            network=host

      # 4. Đăng nhập vào GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. Lấy metadata cho tagging
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha
            type=raw,value=latest

      # 6. Build và push Docker image
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./vfdashboard
          platforms: ${{ matrix.platform }}
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-${{ matrix.arch }}:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-${{ matrix.arch }}:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # 7. Cập nhật tag manifest cho image multi-arch (tùy chọn)
      - name: Create multi-arch manifest
        if: matrix.arch == 'amd64'  # Chỉ chạy một lần sau tất cả job
        run: |
          docker pull ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-amd64:${{ github.sha }}
          docker pull ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-aarch64:${{ github.sha }}
          docker pull ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-armhf:${{ github.sha }}
          docker pull ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-armv7:${{ github.sha }}
          
          docker manifest create ghcr.io/${{ github.repository_owner }}/vinfast-dashboard:${{ github.sha }} \
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-amd64:${{ github.sha }} \
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-aarch64:${{ github.sha }} \
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-armhf:${{ github.sha }} \
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-armv7:${{ github.sha }}
          
          docker manifest push ghcr.io/${{ github.repository_owner }}/vinfast-dashboard:${{ github.sha }}
          
          # Cập nhật tag latest
          docker manifest create ghcr.io/${{ github.repository_owner }}/vinfast-dashboard:latest \
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-amd64:${{ github.sha }} \
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-aarch64:${{ github.sha }} \
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-armhf:${{ github.sha }} \
            ghcr.io/${{ github.repository_owner }}/vinfast-dashboard-armv7:${{ github.sha }}
          
          docker manifest push ghcr.io/${{ github.repository_owner }}/vinfast-dashboard:latest

  # Job 2: Xác thực cấu trúc add-on
  validate-addon:
    runs-on: ubuntu-latest
    needs: build-and-push  # Chạy sau khi build thành công
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate config.yaml
        run: |
          echo "Validating config.yaml structure..."
          
          # Kiểm tra file tồn tại
          if [ ! -f "vfdashboard/config.yaml" ]; then
            echo "❌ ERROR: config.yaml not found!"
            exit 1
          fi
          
          # Kiểm tra các trường bắt buộc
          REQUIRED_FIELDS="name version slug description arch"
          for field in $REQUIRED_FIELDS; do
            if ! grep -q "^$field:" vfdashboard/config.yaml; then
              echo "❌ ERROR: Missing required field: $field"
              exit 1
            fi
          done
          
          # Kiểm tra định dạng image
          if ! grep -q "image:.*{arch}" vfdashboard/config.yaml; then
            echo "❌ ERROR: Image field must contain {arch} placeholder"
            exit 1
          fi
          
          echo "✅ config.yaml validation passed!"

      - name: Validate Dockerfile
        run: |
          echo "Validating Dockerfile..."
          if [ ! -f "vfdashboard/Dockerfile" ]; then
            echo "❌ ERROR: Dockerfile not found!"
            exit 1
          fi
          
          # Kiểm tra EXPOSE port
          if ! grep -q "^EXPOSE" vfdashboard/Dockerfile; then
            echo "⚠ WARNING: Dockerfile missing EXPOSE instruction"
          fi
          
          echo "✅ Dockerfile validation passed!"
